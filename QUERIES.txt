SELECT  
    A.TIM_DAY AS FECHA,
    A.ACCOUNT_NAME,
    CAST(SUM(A.COST_LC) AS INT64) AS COSTO,
    CAST(SUM(A.CONVERSION_VALUE_LC) AS INT64) AS CONVERSION,
    CAST(SUM(OGMV_LC) AS INT64) AS OGMV,
    AVG(A.TARGET_ROAS) AS TROAS
    , LAG(avg(A.TARGET_ROAS),1) OVER(ORDER BY A.TIM_DAY) AS pre_troas
    , ((AVG(A.TARGET_ROAS))/(LAG(avg(A.TARGET_ROAS),1) OVER(ORDER BY A.TIM_DAY))-1)*100 as difRoas
FROM 
    `meli-marketing.MKTPUBLIC.V_BT_TOOLS_ATTRIBUTION_MODEL_ML_V2_TABLEAU` A
WHERE 
    A.SIT_SITE_ID = 'MLA'
    AND LOWER(A.ACCOUNT_NAME) LIKE '%search%ropa%_cat%'
    AND TIM_DAY > '2021-10-01'
GROUP BY 
    A.TIM_DAY, 
    A.ACCOUNT_NAME
ORDER BY    
    A.TIM_DAY


-- TOTAL SITE VS SARCH / DSA

WITH 
    --ARMAMOS TABLA DE SEARCH
 SEARCH AS (
    SELECT     
    TIM_DAY, 
    VERTICAL_CATEG_NAME, 
    CAST(SUM(OGMV_LC) AS INT64) AS OGMV_SEARCH,
    CAST(SUM(COST_LC) AS INT64) AS COST_SEARCH,
    CAST(SUM(CONVERSION_VALUE_LC) AS INT64)AS  CONVERSION_VALUE_SEARCH,
    AVG(TARGET_ROAS) TROAS_SEARCH,
    (SUM(COST_LC)/SUM(OGMV_LC)) AS ADCOST_SEARCH,
    FROM `meli-marketing.MKTPUBLIC.V_BT_TOOLS_ATTRIBUTION_MODEL_ML_V2_TABLEAU`
    WHERE LOWER(ACCOUNT_NAME) LIKE '%search%'
    AND TIM_DAY = DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)  --'2021-10-12'
    AND SIT_SITE_ID = 'MLA'
    AND VERTICAL_CATEG_ID IS NOT NULL 
    AND VERTICAL_CATEG_NAME IS NOT NULL
    GROUP BY 
	TIM_DAY,
	VERTICAL_CATEG_NAME
)
    -- ARMAMOS TABLA DE DSA
, DSA AS (
    SELECT     
    TIM_DAY, 
    VERTICAL_CATEG_NAME, 
    CAST(SUM(OGMV_LC) AS INT64) OGMV_DSA,
    CAST(SUM(COST_LC) AS INT64) COST_DSA,
    (SUM(COST_LC)/SUM(OGMV_LC)) AS ADCOST_DSA,
    CAST(SUM(CONVERSION_VALUE_LC) AS INT64)AS CONVERSION_VALUE_DSA,
    AVG(TARGET_ROAS) TROAS_DSA
    FROM `meli-marketing.MKTPUBLIC.V_BT_TOOLS_ATTRIBUTION_MODEL_ML_V2_TABLEAU`
    WHERE TIPO = 'DSA'
    AND TIM_DAY =DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)  --'2021-10-12''2021-10-11'
    AND SIT_SITE_ID = 'MLA'
    AND VERTICAL_CATEG_ID IS NOT NULL 
    AND VERTICAL_CATEG_NAME IS NOT NULL
    GROUP BY 
	TIM_DAY,
	VERTICAL_CATEG_NAME
)
    -- ARMAMOS TABLA DE SITE
, SITE AS (
    SELECT 
    TIM_DAY,
    CAT_CATEG_NAME_L1,
    CAST(SUM(TGMV_LC) AS INT64) AS TGMV_TS,
    CAST(SUM(SESSIONS) AS INT64) AS SESIONES_TS,
    (SUM(TGMV_LC)/SUM(SESSIONS) ) AS TMGV_SESIONES_TS,
    FROM `meli-marketing.MKTPUBLIC.V_BT_KPI_DAILY_ML_SUMMARY_L1`
    WHERE SIT_SITE_ID = 'MLA'
    AND TIM_DAY = DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)  --'2021-10-12'
    AND CAT_CATEG_NAME_L1 IS NOT NULL
    GROUP BY 
	TIM_DAY
	,CAT_CATEG_NAME_L1
)
SELECT 
    -- FECHA Y VERTICALES
    search.TIM_DAY, 
    search.VERTICAL_CATEG_NAME as SEARCH_VERTICAL, 
    site.CAT_CATEG_NAME_L1 AS SITE_VERTICAL,
    dsa.VERTICAL_CATEG_NAME AS DSA_VERTICAL,

    -- TOTAL SITE
    site.TGMV_TS AS TGMV_SITE,
    SITE.SESIONES_TS,
    site.TMGV_SESIONES_TS,

    -- SEARCH
    search.COST_SEARCH AS COSTO_SEARCH,
    search.OGMV_SEARCH AS OGMV_SEARCH,
    search.CONVERSION_VALUE_SEARCH AS CONVERSION_SEARCH,
    search.ADCOST_SEARCH,
    search.TROAS_SEARCH AS TROAS_SEARCH,
    -- DSA

    dsa.COST_DSA AS COSTO_DSA,
    dsa.OGMV_DSA AS OGMV_DSA,
    dsa.TROAS_DSA AS TROAS_DSA,
    dsa.ADCOST_DSA AS ADCOST_DSA,

    --DSA VS SEARCH
    (SAFE_DIVIDE(CAST(DSA.TROAS_DSA AS INT64),CAST(SEARCH.TROAS_SEARCH AS INT64))-1) AS Percentage_TROAS_DSA_SEARCH,
    (SAFE_DIVIDE(CAST(DSA.COST_DSA  AS INT64),CAST(SEARCH.COST_SEARCH AS INT64))-1) AS Percentage_COST_DSA_SEARCH,
    (SAFE_DIVIDE(CAST(DSA.ADCOST_DSA*1000  AS INT64),CAST(SEARCH.ADCOST_SEARCH*1000 AS INT64))-1) AS Percentage_ADCOST_DSA_SEARCH,
--    ((dsa.TROAS_DSA )/(search.TROAS_SEARCH)) as Roas_dsa_search


    -- CRUCE SEARCH - TOTAL SITE
FROM SEARCH
LEFT JOIN SITE
    ON search.TIM_DAY = site.TIM_DAY
    AND LOWER(search.VERTICAL_CATEG_NAME) = LOWER(site.CAT_CATEG_NAME_L1)
    -- CRUCE SERARCH.TOTAL SITE - DSA
LEFT JOIN DSA 
    ON search.TIM_DAY = dsa.TIM_DAY
    AND LOWER(search.VERTICAL_CATEG_NAME) = LOWER(dsa.VERTICAL_CATEG_NAME)
ORDER BY 
    search.VERTICAL_CATEG_NAME,
    search.TIM_DAY DESC
